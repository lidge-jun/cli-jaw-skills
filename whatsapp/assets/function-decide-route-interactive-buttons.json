{
  "name": "decide-route-interactive-buttons",
  "description": "Decide node helper: route to the next edge based on vars.button_choice from an interactive button reply.",
  "code": "async function handler(request, env) {\n  const payload = await request.json();\n\n  const executionContext = payload && payload.execution_context ? payload.execution_context : {};\n  const vars = executionContext && executionContext.vars ? executionContext.vars : {};\n  const availableEdges = Array.isArray(payload && payload.available_edges) ? payload.available_edges : [];\n\n  const raw = vars.button_choice ?? vars.last_user_input;\n\n  function asString(value) {\n    if (typeof value === 'string') return value;\n    if (typeof value === 'number') return String(value);\n    if (value && typeof value === 'object') {\n      try {\n        return JSON.stringify(value);\n      } catch {\n        return null;\n      }\n    }\n    return null;\n  }\n\n  function extractChoice(value) {\n    if (!value) return null;\n\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed.length === 0) return null;\n      return trimmed;\n    }\n\n    if (value && typeof value === 'object') {\n      const v = value;\n      const direct = v.button_id || v.buttonId || v.list_id || v.listId || v.id || v.choice || v.value;\n      if (typeof direct === 'string' && direct.trim().length > 0) return direct.trim();\n\n      // Common nested shapes.\n      const nested =\n        (v.interactive && (v.interactive.button_reply || v.interactive.list_reply)) ||\n        v.button_reply ||\n        v.list_reply;\n\n      if (nested && typeof nested === 'object') {\n        const nestedId = nested.id || nested.button_id || nested.list_id;\n        if (typeof nestedId === 'string' && nestedId.trim().length > 0) return nestedId.trim();\n      }\n    }\n\n    return null;\n  }\n\n  const extracted = extractChoice(raw);\n  const normalized = extracted ? extracted.toLowerCase().trim() : null;\n\n  // Map common variants to canonical edge labels.\n  const mapped = normalized === 'sale' ? 'sales' : normalized;\n\n  if (mapped && availableEdges.includes(mapped)) {\n    return new Response(JSON.stringify({ next_edge: mapped }), {\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n\n  const fallback = availableEdges[0] || 'next';\n  const reason = {\n    extracted: extracted,\n    raw_preview: asString(raw),\n    available_edges: availableEdges\n  };\n\n  return new Response(JSON.stringify({ next_edge: fallback, vars: { decision_reason: reason } }), {\n    headers: { 'Content-Type': 'application/json' }\n  });\n}\n"
}

